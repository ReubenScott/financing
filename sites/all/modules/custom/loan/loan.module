<?php


/**
 * Implement hook_menu
 */
function loan_menu() {
  $items = array();

  $items['loan'] = array(
    'title' => 'loan',
    'page callback' => 'loan_list',
    'access arguments' => array('access content'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items ['loan/add'] = array(
    'page callback' => 'drupal_get_form',
    'page arguments' => array('loan_form'),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK
  );
  $items ['loan/save'] = array(
    'page callback' => 'loan_save',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK
  );
  $items ['loan/view/%'] = array(
    'page callback' => 'loan_view',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK
  );
  $items ['loan/edit/%'] = array(
    'page callback' => 'drupal_get_form',
    'page arguments' => array('loan_form'),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK
  );

  return $items;
}


/**
 * Implements hook_theme()
 */
function loan_theme() {
  return array(
    'loan_form' => array(
      'template' => 'template/loan_form',
      'arguments' => array('form' => NULL),
  ),
    'loan_list' => array(
      'template' => 'template/loan_list',
      'arguments' => array('form' => NULL),
  ),
    'loan_view' => array(
      'template' => 'template/loan_view',
      'arguments' => array('form' => NULL),
  ),
  );
}

/**
 * Implements hook_init().
 *
 */
function loan_init() {
  //  module_load_include('inc', 'loan', 'includes/loan');


}

function loan_list() {
  drupal_set_title(t('借款'));
  $output = theme('loan_list');
  return $output;
}

function loan_view(){
  drupal_set_title(t('借款'));
  $output = theme('loan_view');
  return $output;
}


function loan_form($id) {
  $form['loan_id'] = array(
    '#type' => 'hidden',
    '#value' => $id,
  );
  $form['loan_platform'] = array(
    '#title' => t('借贷平台'),
    '#required' => TRUE,
    '#type' => 'textfield',
    '#id' => 'loan_platform',
    '#name' => 'loan_platform',
    '#attributes' => array('placeholder' => 'Enter 借贷平台'),
  );
  $form['contract_number'] = array(
    '#title' => t('合同编号'),
    '#type' => 'textfield',
    '#id' => 'contract_number',
    '#name' => 'contract_number',
    '#attributes' => array('placeholder' => 'Enter contract_number'),
  );
  $form['item_name'] = array(
    '#title' => t('项目名称'),
    '#required' => TRUE,
    '#type' => 'textfield',
    '#id' => 'item_name',
    '#name' => 'item_name',
    '#attributes' => array('placeholder' => 'Enter loan Name'),
  );
  $form['principal'] = array(
    '#title' => t('借款金额'),
    '#required' => TRUE,
    '#type' => 'textfield',
    '#id' => 'principal',
    '#name' => 'principal',
    '#attributes' => array('placeholder' => 'Enter loan Part #'),
  );
  $form['period'] = array(
    '#title' => t('期限'),
    '#type' => 'textfield',
    '#id' => 'period',
    '#name' => 'period',
  );
  $form['annualized_return'] = array(
    '#title' => t('年化收益'),
    '#type' => 'textfield',
    '#id' => 'annualized_return',
    '#name' => 'annualized_return',
  );
  $form['loan_time'] = array(
    '#title' => t('借款时间'),
    '#required' => TRUE,
    '#id' => 'loan_time',
    '#name' => 'loan_time',
    '#type' => 'date_popup',
    '#date_format' => 'm/d/Y',
    '#maxlength' => 10,
    '#date_year_range' => '-5:+6',
    '#attributes' => array('title' => t("Click the calendar to select the date."),'readonly' => true),
    '#date_label_position' => 'within',  
  );
  $form['expiration_time'] = array(
    '#title' => t('到期时间'),
    '#name' => 'expiration_time',
    '#id' => 'expiration_time',    
    '#type' => 'date_popup',
    '#date_format' => 'm/d/Y',
    '#maxlength' => 10,
    '#date_year_range' => '-5:+6',
    '#attributes' => array('title' => t("Click the calendar to select the date."),'readonly' => true),
    '#date_label_position' => 'within',  
  );
  $form['payment_mode'] = array(
    '#title' => t('回款方式'),
    '#type' => 'textfield',
    '#id' => 'payment_mode',
    '#name' => 'payment_mode',
  );
  $form['contract_attachment'] = array(
    '#title' => t('合同'),
    '#type' => 'file',
    '#id' => 'contract_attachment',
    '#name' => 'contract_attachment',
  );

  $form['reset'] = array ('#value' => '<input type="reset" value="Reset">');
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save'),
  );

  $form['#action'] = $id ? url('loan/update') : url('loan/save');
  $form['#attributes'] = array('enctype' => "multipart/form-data"); //upload file must attributes
  //  $form['#theme'] = array('covidien_loan_form');
  //  $form['#validate'] = array('covidien_loan_form_validate');
  //  $form['#submit'] = array('covidien_loan_form_submit');

  return $form;
}


/**
 * Validate the form.
 */
function loan_form_validate($form, &$form_state) {
  if ($form_state['values']['user_name'] == 'King Kong') {
    // We notify the form API that this field has failed validation.
    form_set_error('user_name',
    t('King Kong is not allowed to use this form.'));
  }
}
/**
 * Handle post-validation form submission.
 */
function loan_form_submit($form, &$form_state) {
  $name = $form_state['values']['user_name'];
  drupal_set_message(t('Thanks for filling out the form, %name', array('%name' => $name)));
}




/**
 * Enter description here...
 *
 * @param unknown_type $vars
 */
function template_preprocess_loan_form(&$vars) {
  $loan_id = arg(2);
  //add covidien_firmware_form
  $loan_form = loan_form($loan_id);
  //if edit
  $vars['loan_form'] = $loan_form;
  
  
  
}


/**
 * Enter description here...
 *
 * @param unknown_type $vars
 */
function template_preprocess_loan_list(&$vars) {
  $html = '';
  //header
  $header = array(
  array('data' => t('借贷平台'), 'field' => 'loan_platform'),
  array('data' => t('合同编号'), 'field' => 'contract_number'),
  array('data' => t('项目名称'), 'field' => 'item_name'),
  array('data' => t('借款金额'), 'field' => 'principal'),
  array('data' => t('借款时间'), 'field' => 'loan_time', 'sort' => 'desc'),
  array('data' => t('年化收益'), 'field' => 'annualized_return'),
  array('data' => t('到期时间'), 'field' => 'expiration_time'),
  array('data' => t('回款方式'), 'field' => 'payment_mode'),
  array('data' => t('操作')),
  );

  $query = pager_query("SELECT * FROM loan" . tablesort_sql($header), $limit = 30);

  $rows= array();

  while ($row = db_fetch_array($query)) {
    $rows[] = array(
    $row['loan_platform'],
    $row['contract_number'],
    $row['item_name'],
    $row['principal'],
    $row['loan_time'] ? date('Y-m-d', $row['loan_time']): '',
    $row['annualized_return'],
    $row['expiration_time'] ? date('Y-m-d', $row['expiration_time']): '',
    $row['payment_mode'],
      '<a href="'.url('loan/view/'.$row['loan_id']) .'">查看</a> 
       <a href="'.url('loan/edit/'.$row['loan_id']) .'">编辑</a>
       <a href="'.url('loan/delete/'.$row['loan_id']) .'">删除</a>
      '
      );
  }

  $html .= theme('table', $header, $rows);
  $html .= theme('pager');

  $vars['html'] = $html;

}

/**
 * Enter view loan details
 *
 * @param unknown_type $vars
 */
function template_preprocess_loan_view(&$vars) {
  $loan_id = arg(2);
  $loan = array();
  if ($loan_id && is_numeric($loan_id)) {
    $query = "SELECT loan_id, loan_platform, contract_number, item_name, principal, period, annualized_return, loan_time, expiration_time
        FROM {loan} WHERE loan_id = %d";
    $result = db_query($query, $loan_id);
    $row = db_fetch_object($result);
    $loan = array(
      'loan_id' => $row->loan_id,
      'loan_platform' => $row->loan_platform,
      'contract_number' => $row->contract_number,
      'item_name' => $row->item_name,
      'principal' => $row->principal,
      'period' => $row->period,
      'annualized_return' => $row->annualized_return,
      'loan_time' => $row->loan_time,
      'expiration_time' => $row->expiration_time,
    );
  }

  $vars['loan'] = $loan;
}


/**
 *  add load
 * @return unknown_type
 */
function loan_save() {
  global $drupal_abs_path, $user;
  $loan_id = $_POST['loan_id'];
  $loan_platform = $_POST['loan_platform'];
  $contract_number = $_POST['contract_number'];
  $item_name = $_POST['item_name'];
  $principal = $_POST['principal'];
  $annualized_return = $_POST['annualized_return'];
  $period = $_POST['period'];
  $loan_time = $_POST['loan_time'];
  $expiration_time = $_POST['expiration_time'];
  $payment_mode = $_POST['payment_mode'];

  $loan_time = time();
  $expiration_time = time();

  $insert_loan_sql = "INSERT INTO {loan} (
      loan_platform, contract_number, item_name, 
      principal, period, annualized_return, 
      loan_time,  expiration_time, payment_mode
    )	VALUES ('%s', '%s', '%s', %f, '%s', %f, %d, %d, '%s')";

  $flag = db_query($insert_loan_sql,
  $loan_platform , $contract_number, $item_name,
  $principal, $period, $annualized_return,
  $loan_time, $expiration_time, $payment_mode);

  if($flag){
    $message = t('loan @name has been created. ', array('@name' => $item_name));
  } else{
    $message = t('loan created failed. ', array('@name' => $item_name));
  }


  drupal_set_message($message);
  drupal_goto('loan');
}


























